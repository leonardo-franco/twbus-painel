<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Painel interativo para informações de parada de ônibus em tempo real">
    <meta name="keywords" content="ônibus, transporte público, parada, tempo real, São Paulo">
    <meta name="author" content="TwBus">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://twbus.vercel.app; worker-src 'self'; manifest-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none'; media-src 'none'; child-src 'none';">
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="icon" type="image/png" href="icon-512.svg">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Security Configuration -->
    <script src="security-config.js"></script>
    
    <title>TwBus - Painel de Parada</title>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho com número e tempo -->
        <div class="header">
            <div class="bus-info">
                <div class="bus-number">
                    <i class="fas fa-bus"></i>
                    <span class="number">174</span>
                </div>
                <div class="divider"></div>
                <div class="arrival-time">
                    <i class="fas fa-clock"></i>
                    <span class="time">5 min</span>
                </div>
            </div>
        </div>

        <!-- Seção da rota -->
        <div class="route-section">
            <div class="section-header">
                <h3><i class="fas fa-route"></i> Rota do Ônibus</h3>
                <div class="route-controls">
                    <button class="control-btn" id="refreshBtn" title="Atualizar informações" aria-label="Atualizar informações">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="control-btn" id="expandBtn" title="Expandir/Recolher rota" aria-label="Expandir ou recolher rota">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="route-container">
                <div class="route-line">
                    <!-- Paradas anteriores (visíveis apenas no modo expandido) -->
                    <div class="stop passed extra hidden">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Terminal Barra Funda</span>
                            <span class="stop-status">Passou</span>
                        </div>
                    </div>
                    
                    <div class="stop passed extra hidden">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Memorial da América Latina</span>
                            <span class="stop-status">Passou</span>
                        </div>
                    </div>
                    
                    <div class="stop passed extra hidden">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Estação Marechal Deodoro</span>
                            <span class="stop-status">Passou</span>
                        </div>
                    </div>
                    
                    <!-- Paradas principais (sempre visíveis) -->
                    <div class="stop passed">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Praça da Sé</span>
                            <span class="stop-status">Passou</span>
                        </div>
                    </div>
                    
                    <div class="stop current-bus highlighted">
                        <div class="stop-icon">
                            <i class="fas fa-bus"></i>
                        </div>
                        <div class="stop-info">
                            <span class="stop-name">Rua Júlio Mesquita</span>
                            <span class="stop-status">Ônibus aqui</span>
                        </div>
                    </div>
                    
                    <div class="stop next">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Av. São João</span>
                            <span class="stop-status">Próxima</span>
                        </div>
                    </div>
                    
                    <div class="stop current-location highlighted">
                        <div class="stop-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="stop-info">
                            <span class="stop-name">Ópera</span>
                            <span class="stop-status">Você está aqui</span>
                        </div>
                    </div>
                    
                    <div class="stop upcoming">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Estação da Luz</span>
                            <span class="stop-status">Após você</span>
                        </div>
                    </div>
                    
                    <div class="stop upcoming">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Pinacoteca</span>
                            <span class="stop-status">Após você</span>
                        </div>
                    </div>
                    
                    <div class="stop upcoming">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Jardim da Luz</span>
                            <span class="stop-status">Após você</span>
                        </div>
                    </div>
                    
                    <!-- Paradas posteriores (visíveis apenas no modo expandido) -->
                    <div class="stop upcoming extra hidden">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Estação Tiradentes</span>
                            <span class="stop-status">Após você</span>
                        </div>
                    </div>
                    
                    <div class="stop upcoming extra hidden">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Mercado Municipal</span>
                            <span class="stop-status">Após você</span>
                        </div>
                    </div>
                    
                    <div class="stop upcoming extra hidden">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Rua 25 de Março</span>
                            <span class="stop-status">Após você</span>
                        </div>
                    </div>
                    
                    <div class="stop upcoming extra hidden">
                        <div class="stop-icon"></div>
                        <div class="stop-info">
                            <span class="stop-name">Terminal Parque Dom Pedro</span>
                            <span class="stop-status">Final</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção de informações adicionais -->
        <div class="info-section">
            <div class="info-card">
                <div class="info-item">
                    <i class="fas fa-users"></i>
                    <div class="info-content">
                        <span class="info-label">Lugares livres</span>
                        <span class="info-value available">12</span>
                    </div>
                </div>
                <div class="info-divider"></div>
                <div class="info-item">
                    <i class="fas fa-bus"></i>
                    <div class="info-content">
                        <span class="info-label">Próximo ônibus</span>
                        <span class="info-value next-bus">15 min</span>
                    </div>
                </div>
            </div>
            <div class="additional-info">
                <div class="info-badge">
                    <i class="fas fa-wifi"></i>
                    <span>Wi-Fi disponível</span>
                </div>
                <div class="info-badge">
                    <i class="fas fa-wheelchair"></i>
                    <span>Acessível</span>
                </div>
            </div>
        </div>

        <!-- Rodapé -->
        <div class="footer">
            <div class="update-time">
                <i class="fas fa-sync-alt"></i>
                <span>Atualizado: 14:32</span>
            </div>
            <div class="admin-access admin-relative">
                <button id="adminBtn" class="admin-btn" title="Acesso Administrativo">
                    ⚙️
                </button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="tests.js"></script>
    <script>
        // Inicialização do painel e testes automáticos
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Aguardar carregamento dos scripts
                if (typeof BusPanel === 'undefined') {
                    console.warn('⚠️ BusPanel não encontrado, usando modo básico');
                    return;
                }
                
                // Inicializar painel principal
                window.busPanel = new BusPanel();
                console.log('✅ Painel TwBus inicializado com sucesso');
                
                // Verificar se o sistema de testes está disponível
                if (typeof BusPanelTester !== 'undefined') {
                    // Executar testes de segurança automaticamente
                    console.log('\n🔒 Iniciando testes de segurança automáticos...');
                    const tester = new BusPanelTester();
                    
                    // Registrar todos os testes
                    tester.registerAllTests();
                    
                    // Executar testes
                    const testsPassed = await tester.runAllTests();
                    
                    // Mostrar resultado visual
                    if (testsPassed) {
                        console.log('\n🎉 Todos os testes de segurança passaram!');
                        document.body.classList.add('tests-passed');
                        
                        // Adicionar indicador visual de sucesso
                        const successIndicator = document.createElement('div');
                        successIndicator.className = 'test-success-indicator';
                        successIndicator.innerHTML = '✅ Testes OK';
                        successIndicator.title = 'Todos os testes de segurança passaram';
                        document.body.appendChild(successIndicator);
                    } else {
                        console.error('\n⚠️ Alguns testes falharam - verifique o console');
                        document.body.classList.add('tests-failed');
                        
                        // Adicionar indicador visual de falha
                        const failIndicator = document.createElement('div');
                        failIndicator.className = 'test-fail-indicator';
                        failIndicator.innerHTML = '⚠️ Testes';
                        failIndicator.title = 'Alguns testes falharam - verifique o console';
                        document.body.appendChild(failIndicator);
                    }
                } else {
                    console.warn('⚠️ Sistema de testes não carregado');
                }
                
            } catch (error) {
                console.error('❌ Erro crítico na inicialização:', error);
                document.body.classList.add('error-state');
                
                // Indicador de erro crítico
                const errorIndicator = document.createElement('div');
                errorIndicator.className = 'critical-error-indicator';
                errorIndicator.innerHTML = '🚨 Erro';
                errorIndicator.title = 'Erro crítico - verifique o console';
                document.body.appendChild(errorIndicator);
            }
        });
        
        // PWA e Service Worker
        let deferredPrompt;
        let installBtn = document.getElementById('installBtn');
        let installBanner = document.getElementById('installBanner');
        let installBannerBtn = document.getElementById('installBannerBtn');
        let dismissBannerBtn = document.getElementById('dismissBannerBtn');

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            console.log('🔄 Service Worker: Nova versão detectada');
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('⬆️ Service Worker: Atualização disponível');
                                    showUpdateAvailable();
                                }
                            });
                        });
                        
                        // Log cache status
                        caches.keys().then(cacheNames => {
                            console.log('📂 Caches disponíveis:', cacheNames);
                        });
                    })
                    .catch(error => {
                        console.error('❌ Service Worker falhou:', error);
                    });
            });
        } else {
            console.warn('⚠️ Service Worker não suportado neste navegador');
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('💾 PWA: Install prompt disponível');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner after 3 seconds
            setTimeout(() => {
                if (!localStorage.getItem('pwa-dismissed')) {
                    if (installBanner) {
                        installBanner.style.display = 'block';
                        installBanner.classList.add('show');
                    }
                }
            }, 3000);
            
            if (installBtn) installBtn.style.display = 'flex';
        });

        // Install button click
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') {
                        console.log('✅ PWA: Usuário aceitou instalação');
                        hideBanner();
                    } else {
                        console.log('❌ PWA: Usuário recusou instalação');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Event listeners for install
        if (installBtn) {
            installBtn.addEventListener('click', installPWA);
        }
        
        if (installBannerBtn) {
            installBannerBtn.addEventListener('click', installPWA);
        }

        if (dismissBannerBtn) {
            dismissBannerBtn.addEventListener('click', () => {
                hideBanner();
                localStorage.setItem('pwa-dismissed', 'true');
            });
        }

        function hideBanner() {
            if (installBanner) {
                installBanner.classList.remove('show');
                setTimeout(() => {
                    installBanner.style.display = 'none';
                }, 300);
            }
        }

        // App installed
        window.addEventListener('appinstalled', () => {
            console.log('🎉 PWA: App instalado com sucesso');
            if (installBtn) installBtn.style.display = 'none';
            hideBanner();
            
            // Show welcome message
            if (window.busPanel) {
                setTimeout(() => {
                    alert('🎉 TwBus instalado com sucesso!\nAgora você pode acessar offline.');
                }, 1000);
            }
        });

        // Show update available notification
        function showUpdateAvailable() {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'update-banner';
            updateBanner.innerHTML = `
                <div class="banner-content">
                    <span>🔄 Nova versão disponível!</span>
                    <button onclick="updateApp()" class="btn-update">Atualizar</button>
                </div>
            `;
            document.body.appendChild(updateBanner);
        }

        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.update();
                    window.location.reload();
                });
            }
        }

        // Network status
        window.addEventListener('online', () => {
            console.log('🌐 Conexão restaurada');
            document.body.classList.remove('offline');
        });

        window.addEventListener('offline', () => {
            console.log('📱 Modo offline ativado');
            document.body.classList.add('offline');
        });
        
        // Admin access button
        const adminBtn = document.getElementById('adminBtn');
        if (adminBtn) {
            adminBtn.addEventListener('click', function() {
                let clickCount = this.dataset.clicks || 0;
                clickCount++;
                this.dataset.clicks = clickCount;
                
                // Múltiplos cliques para acesso administrativo (segurança por obscuridade)
                if (clickCount >= 5) {
                    window.location.href = 'admin-login.html';
                }
                
                // Reset counter após 3 segundos
                setTimeout(() => {
                    this.dataset.clicks = 0;
                }, 3000);
                
                // Feedback visual
                this.style.color = clickCount >= 3 ? 'rgba(255,255,255,0.6)' : 'rgba(255,255,255,0.2)';
            });
            
            // Hover effect para o botão admin
            adminBtn.addEventListener('mouseenter', function() {
                this.style.color = 'rgba(255,255,255,0.5)';
                this.style.background = 'rgba(255,255,255,0.1)';
            });
            
            adminBtn.addEventListener('mouseleave', function() {
                this.style.color = 'rgba(255,255,255,0.2)';
                this.style.background = 'none';
            });
        }
    </script>
</body>
</html>